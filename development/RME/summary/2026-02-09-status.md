# 2026-02-09 Status

## Summary
Continued the black-map investigation and built a reproducible runtime validation harness. Added patch logging, autorun map loading, autoscreenshot capture, and DB open-failure diagnostics to make missing assets and map-load regressions visible in logs. Fixed macOS working-directory selection so the app can find `master.dat`/`critter.dat` when launched from the app bundle Resources folder. Added a runtime map sweep script to load every MAP and capture screenshots. Tightened parsing of proto list lines to strip CR to avoid CRLF-induced missing proto/art lookups.

## Key Changes
- Added patch logging helper with context tracking (new files).
  - Files: `src/plib/db/patchlog.cc`, `src/plib/db/patchlog.h` (wired via `CMakeLists.txt`).
- DB diagnostics:
  - `db_diag_*` counters to flag unexpected DB open failures (used by autorun).
  - Logging for DB init/open failures and context.
  - Filters for expected misses: `.SAV` and `.GAM`.
  - Files: `src/plib/db/db.cc`, `src/plib/db/db.h`.
- Autorun + autoscreenshot hooks:
  - `F1R_AUTORUN_MAP` to load a map and exit.
  - `F1R_AUTOSCREENSHOT=1` to call `dump_screen()` after map load.
  - Return codes reflect map-load failures and DB open failures during map load.
  - Files: `src/game/main.cc`.
- Map-level diagnostics:
  - Log `MAP_HEADER` and `SQUARE_STATS` (tile id distribution).
  - Skip map-enter script execution when autorun is active to avoid long-running script hangs during sweep.
  - Files: `src/game/map.cc`.
- CRLF fix for proto lists:
  - Strip `\r` in `proto_list_str` to avoid `"...PRO\r"` lookups.
  - File: `src/game/proto.cc`.
- SDL headless compatibility:
  - Detect `dummy/offscreen` video drivers; allow missing logical presentation.
  - File: `src/plib/gnw/svga.cc`.
- macOS working directory:
  - Prefer current working directory if it already contains game data (prevents chdir to app root when launched from `Resources`).
  - File: `src/plib/gnw/winmain.cc`.
- Runtime sweep tool:
  - Script to load every MAP and capture screenshots with a black-map heuristic.
  - Fix timeout handling when stdout is bytes.
  - File: `scripts/patch/rme-runtime-sweep.py`.
- Render pipeline instrumentation and safe-fill:
  - Added per-stage render instrumentation to correlate source, surface, display, texture, and present states and to identify transient zeroing events (new patchlog tags: `GNW_SHOW_RECT_SRC`, `GNW_SHOW_RECT`, `GNW_SURF_SUSPECT`, `RENDER_PRESENT_*`).
  - Implemented an atomic "composite-fill" for `WIN_FILL_RECT` that applies background fill and restores overlapping map content in a single blit to avoid transient blank presentation.
  - Added `scripts/dev/patchlog_analyze.py` to detect suspicious `surf_pre>0 && surf_post==0` transitions and correlate them with `WIN_FILL_RECT` / `MAP_SCROLL_MEMMOVE` operations.
  - Files: `src/plib/gnw/svga.cc`, `src/plib/gnw/gnw.cc`, `scripts/dev/patchlog_analyze.py`.

## Tests/Commands Run
- Build: `./scripts/build/build-macos.sh` (multiple times).
- Install data: `./scripts/test/test-install-game-data.sh` (patched and unpatched).
- Validate data overlay: `./scripts/patch/rebirth-validate-data.sh`.
- Headless smoke: `./scripts/test/test-macos-headless.sh`.
- Autorun map tests with patchlog/screenshot:
  - `V13ENT.MAP`, `BRODEAD.MAP`, `BROHD12.MAP`, `CARAVAN.MAP`.
- Runtime map sweep (partial and attempted full):
  - Partial (`--limit 5`) completed.
  - Full run initially timed out at 30s on some maps; timeout handling bug fixed.

## Current Status / Findings
- macOS CWD fix unblocked `master.dat`/`critter.dat` discovery when launching from `Resources`.
- CRLF trimming in proto list resolved `"*.PRO\r"` lookups in patchlog.
- Autorun path now stable for individual maps; return codes are nonzero only when unexpected DB opens fail.
- `CARAVAN.MAP` shows a mostly-black top region in screenshots with normal UI at bottom; instrumentation shows floor pixels are being drawn into the display buffer prior to presentation.
- Render instrumentation results: multiple `GNW_SHOW_RECT` events were observed where a surface is non-zero before a show rect (`surf_pre>0`) and zero after it (`surf_post==0`), frequently adjacent to `WIN_FILL_RECT` fills that target the same top rectangles. `RENDER_PRESENT_ANOMALY` capture was added to save presented frames for manual inspection (`development/RME/validation/runtime/present-anomalies/f1r-present-anom-*.bmp`).
- Fix attempts and status:
  - Short-term: re-blit after fill — stable but may be fragile.
  - Long-term: composite-fill atomic blit — implemented; it initially caused a heap/free crash due to a double-free but the double-free was fixed (commit: `gnw: avoid double-free in WIN_FILL_RECT composite path` on branch `fix/ISSUE-LST-002-comment-no-longer-used`). Build succeeded and the crash no longer reproduces in local runs.
- Next validation actions:
  1. Re-run `CARAVAN.MAP` autorun with `F1R_PATCHLOG=1` and `F1R_PATCHLOG_VERBOSE=1` and analyze via `scripts/dev/patchlog_analyze.py` to confirm composite-fill removes `surf_pre>0 && surf_post==0` cases.
  2. Re-run the full runtime sweep (`scripts/patch/rme-full-coverage.sh`) with `TIMEOUT=90` and verify `runtime_map_sweep.csv` anomalies decrease.
  3. Produce ASAN-enabled build to detect further memory issues (note: initial ASAN configure failed due to a FetchContent network error fetching SDL; consider cloning SDL locally under `third_party/sdl3/SDL` if network fetching continues to fail).

## Next Steps
- Run the full runtime sweep with a larger timeout to identify remaining timeouts/suspicious screenshots.
- Review any maps flagged by the sweep and correlate with patchlog and `SQUARE_STATS` output.
- If black-map persists for specific maps, add focused logging for render/blit or square/tile conversion just for those maps.
